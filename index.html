<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better form visibility */
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            width: 100%;
            max-width: 960px; /* max-w-3xl */
        }
        input[type="text"],
        input[type="number"],
        textarea,
        select,
        input[type="date"] { /* Added input[type="date"] to styling */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.625rem 1rem; /* py-2.5 px-4 */
            width: 100%;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, color 0.15s ease-in-out, background-color 0.15s ease-in-out;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus,
        input[type="date"]:focus { /* Added input[type="date"] to styling */
            border-color: #3b82f6; /* ring-blue-500 */
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* ring-blue-500/25 */
        }
        .section-title {
            border-bottom: 2px solid #e5e7eb; /* border-gray-200 */
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #3b82f6; /* bg-blue-500 */
            color: #ffffff; /* text-white */
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* bg-blue-600 */
        }
        .btn-remove { /* Style for remove buttons */
            background-color: #ef4444; /* bg-red-500 */
            color: #ffffff; /* text-white */
            padding: 0.5rem 0.75rem; /* p-2 */
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s ease-in-out;
        }
        .btn-remove:hover {
            background-color: #dc2626; /* bg-red-600 */
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem; /* space-x-4 and space-y-4 for stacking */
        }
        .form-col {
            flex: 1;
            min-width: 180px; /* Adjusted min-width for more columns in car sales */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .form-row > div {
                flex: 1;
            }
        }
        /* Generic goal display styles - colors handled by JS */
        .goal-display {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            border-left: 4px solid; /* Border color handled by JS */
        }
        .totals-section {
            background-color: #f0f9ff; /* Light blue background for totals */
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #bfdbfe; /* Light blue border */
            margin-top: 2rem;
        }
        .totals-section p {
            font-size: 1.125rem; /* text-lg */
            font-weight: 500;
            color: #1e3a8a; /* Darker blue text */
            margin-bottom: 0.5rem;
        }
        .totals-section p span {
            font-weight: 700; /* bold */
            color: #000; /* Black for values */
        }
        /* Generic highlighted goal styles - colors handled by JS */
        .highlighted-goal {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-top: 1rem;
            border: 2px solid; /* Border color handled by JS */
        }

        /* Classes for dynamic color changes for Remaining Goal */
        .goal-met {
            color: #16a34a; /* green-700 */
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
        }
        .goal-not-met {
            color: #dc2626; /* red-700 */
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
        }

        /* Classes for dynamic color changes for individual Close Ratio inputs */
        input.conversion-met {
            color: #16a34a; /* green-700 */
            border-color: #22c55e; /* green-500 */
            background-color: #dcfce7; /* green-100 */
        }
        input.conversion-not-met {
            color: #dc2626; /* red-700 */
            border-color: #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-8">
            <!-- IMPORTANT: Replace the src below with the actual public URL of your logo. -->
            <!-- Example: <img src="https://yourwebsite.com/images/IMG_5685.png" alt="Mazda's Plus Logo" style="max-width: 200px; height: auto; margin: 0 auto;"> -->
            <img src="https://placehold.co/200xauto/f3f4f6/1f2937?text=Your+Logo+Here" alt="Mazda's Plus Logo" style="max-width: 200px; height: auto; margin: 0 auto;">
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Daily Sales Form</h1>
        <p class="text-gray-600 mb-8 text-center">Track your daily performance as an automotive service writer.</p>

        <form id="salesForm" class="space-y-8" action="https://formspree.io/f/xrbqnjwe" method="POST">
            <input type="hidden" id="pdfData" name="pdfData">
            <input type="hidden" id="formDataJson" name="formDataJson"> <!-- New hidden input for structured JSON -->

            <div class="form-row mb-4">
                <div class="form-col">
                    <label for="reportDate" class="block text-gray-700 text-sm font-medium mb-1">Date</label>
                    <input type="date" id="reportDate" class="w-full rounded-md"> <!-- Removed name attribute -->
                </div>
                <div class="form-col">
                    <label for="serviceAdvisorName" class="block text-gray-700 text-sm font-medium mb-1">Service Advisor Name</label>
                    <select id="serviceAdvisorName" class="w-full rounded-md"> <!-- Removed name attribute -->
                        <option value="Beto Calderon">Beto Calderon</option>
                        <option value="Scott Carvalho">Scott Carvalho</option>
                    </select>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-2xl font-semibold text-gray-700 section-title">Sales Metrics</h2>

                <div class="form-row mb-4">
                    <div class="form-col">
                        <label for="priorDayTotal" class="block text-gray-700 text-sm font-medium mb-1">Prior Day Total ($)</label>
                        <input type="number" id="priorDayTotal" placeholder="e.g., -200" class="w-full rounded-md" step="0.01" oninput="updateDailyGoalBasedOnPriorDay()"> <!-- Removed name attribute -->
                    </div>
                    <div class="form-col">
                        <label for="dailyGoal" class="block text-gray-700 text-sm font-medium mb-1">Daily Goal ($)</label>
                        <input type="number" id="dailyGoal" class="w-full rounded-md" min="0" step="0.01" oninput="updateRemainingGoal()"> <!-- Removed name attribute -->
                    </div>
                </div>

                <div class="goal-display" id="remainingDailyGoalTop">
                    Remaining Daily Goal: $<span id="remainingDailyGoalValueTop">0.00</span>
                </div>

                <div class="space-y-4 pt-4 border-t border-gray-200 mt-6">
                    <h3 class="text-xl font-semibold text-gray-700">Individual Car Sales</h3>
                    <div id="carSalesEntries" class="space-y-4">
                        <div class="form-row items-end">
                            <div class="form-col">
                                <label for="carRepairOrderNumber_1" class="block text-gray-700 text-sm font-medium mb-1">RO#</label>
                                <input type="text" id="carRepairOrderNumber_1" name="carRepairOrderNumber[]" placeholder="RO Number" class="w-full rounded-md">
                            </div>
                            <div class="form-col">
                                <label for="carLastName_1" class="block text-gray-700 text-sm font-medium mb-1">Last Name</label>
                                <input type="text" id="carLastName_1" name="carLastName[]" placeholder="Customer Last Name" class="w-full rounded-md">
                            </div>
                            <div class="form-col">
                                <label for="carDiscoveredSales_1" class="block text-gray-700 text-sm font-medium mb-1">Discovered ($)</label>
                                <input type="number" id="carDiscoveredSales_1" name="carDiscoveredSales[]" placeholder="e.g., 500" class="w-full rounded-md" min="0" step="0.01" oninput="updateRunningTotals()">
                            </div>
                            <div class="form-col">
                                <label for="carSoldSales_1" class="block text-gray-700 text-sm font-medium mb-1">Sold ($)</label>
                                <input type="number" id="carSoldSales_1" name="carSoldSales[]" placeholder="e.g., 350" class="w-full rounded-md" min="0" step="0.01" oninput="updateRemainingGoal(); updateRunningTotals()">
                            </div>
                            <div class="form-col">
                                <label for="carIndividualCloseRatio_1" class="block text-gray-700 text-sm font-medium mb-1">Close Ratio (%)</label>
                                <input type="text" id="carIndividualCloseRatio_1" name="carIndividualCloseRatio[]" class="w-full rounded-md" readonly>
                            </div>
                            <div class="form-col flex items-center pt-6">
                                <input type="checkbox" id="carAppointmentScheduled_1" name="carAppointmentScheduled[]" class="mr-2" onchange="updateRunningTotals()">
                                <label for="carAppointmentScheduled_1" class="text-gray-700 text-sm font-medium">Future Appointment Scheduled?</label>
                            </div>
                            <div class="form-col flex items-center pt-6">
                                <input type="checkbox" id="carInsuranceClaim_1" name="carInsuranceClaim[]" class="mr-2" onchange="toggleInsuranceFields(this.closest('.form-row'))">
                                <label for="carInsuranceClaim_1" class="text-gray-700 text-sm font-medium">Insurance Claim</label>
                            </div>
                            <div class="form-row w-full" id="insurancePayCustomerPayGroup_1" style="display:none;">
                                <div class="form-col">
                                    <label for="carInsuranceSold_1" class="block text-gray-700 text-sm font-medium mb-1">Insurance Sold ($)</label>
                                    <input type="number" id="carInsuranceSold_1" name="carInsuranceSold[]" placeholder="e.g., 200" class="w-full rounded-md" min="0" step="0.01" oninput="updateCarRowTotals(this.closest('.form-row')); updateRunningTotals()">
                                </div>
                                <div class="form-col">
                                    <label for="carCustomerPaySold_1" class="block text-gray-700 text-sm font-medium mb-1">Customer Pay Sold ($)</label>
                                    <input type="number" id="carCustomerPaySold_1" name="carCustomerPaySold[]" placeholder="e.g., 150" class="w-full rounded-md" min="0" step="0.01" oninput="updateCarRowTotals(this.closest('.form-row')); updateRunningTotals()">
                                </div>
                            </div>
                            <div class="w-full sm:w-auto">
                                <button type="button" onclick="removeCarEntry(this)" class="btn-remove hidden">Remove</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addCarEntry()" class="btn-primary text-sm mt-4">Add Another Car</button>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-2xl font-semibold text-gray-700 section-title">New Customer Leads</h2>
                <div id="callEntries" class="space-y-4">
                    <div class="form-row items-end">
                        <div class="form-col">
                            <label for="callCustomerName_1" class="block text-gray-700 text-sm font-medium mb-1">Customer Name</label>
                            <input type="text" id="callCustomerName_1" name="callCustomerName[]" placeholder="Customer Name" class="w-full rounded-md">
                        </div>
                        <div class="form-col">
                            <label for="callCustomerPhone_1" class="block text-gray-700 text-sm font-medium mb-1">Phone Number</label>
                            <input type="text" id="callCustomerPhone_1" name="callCustomerPhone[]" placeholder="(XXX) XXX-XXXX" class="w-full rounded-md" oninput="formatPhoneNumber(this)">
                        </div>
                        <div class="form-col flex items-center">
                            <input type="checkbox" id="callBookedAppointment_1" name="callBookedAppointment[]" class="mr-2" onchange="toggleCallFieldsVisibility(1)">
                            <label for="callBookedAppointment_1" class="text-gray-700 text-sm font-medium">Booked Appointment?</label>
                        </div>
                        <div class="form-col flex items-center">
                            <input type="checkbox" id="callLostLead_1" name="callLostLead[]" class="mr-2" onchange="toggleCallFieldsVisibility(1)">
                            <label for="callLostLead_1" class="text-gray-700 text-sm font-medium">Lost Lead?</label>
                        </div>
                        <div class="form-col" id="callLostCostContainer_1" style="display:none;">
                            <label for="callLostCost_1" class="block text-gray-700 text-sm font-medium mb-1">Estimated Lost Cost ($)</label>
                            <input type="number" id="callLostCost_1" name="callLostCost[]" placeholder="e.g., 250" class="w-full rounded-md" min="0" step="0.01">
                        </div>
                        <div class="form-col" id="callReasonContainer_1" style="display:none;">
                            <label for="callReason_1" class="block text-gray-700 text-sm font-medium mb-1">Reason for Loss</label>
                            <select id="callReason_1" name="callReason[]" class="w-full rounded-md" onchange="toggleOtherReason(this, 1, 'call')">
                                <option value="">Select Reason</option>
                                <option value="Cost">Cost</option>
                                <option value="Appointment Availability">Appointment Availability</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-col" id="callSourceContainer_1" style="display:none;">
                            <label for="callSource_1" class="block text-gray-700 text-sm font-medium mb-1">Source</label>
                            <select id="callSource_1" name="callSource[]" class="w-full rounded-md">
                                <option value="">Select Source</option>
                                <option value="Referral">Referral</option>
                                <option value="Repair Pal">Repair Pal</option>
                                <option value="Google">Google</option>
                                <option value="Social Media">Social Media</option>
                            </select>
                        </div>
                        <div class="w-full sm:w-auto">
                            <button type="button" onclick="removeCallEntry(this)" class="btn-remove hidden">Remove</button>
                        </div>
                        <div class="form-col w-full" id="callOtherReasonContainer_1" style="display:none;">
                            <label for="callOtherReason_1" class="block text-gray-700 text-sm font-medium mb-1">Other Reason Details</label>
                            <textarea id="callOtherReason_1" name="callOtherReason[]" rows="2" placeholder="Please specify other reason" class="w-full rounded-md"></textarea>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addCallEntry()" class="btn-primary text-sm mt-4">Add Another Lead</button>
            </div>

            <div class="text-center mt-6 flex justify-center space-x-4">
                <button type="submit" class="btn-primary" onclick="generatePdfAndSubmit(event)">Submit Daily Report</button>
                <button type="button" onclick="savePageAsImage()" class="btn-primary bg-gray-600 hover:bg-gray-700">Save Page as Image</button>
            </div>

            <div class="totals-section">
                <h2 class="text-2xl font-semibold text-gray-700 section-title">Daily Totals</h2>
                <p>Total Discovered Sales: $<span id="totalDiscoveredSales">0.00</span></p>
                <p>Total Sold Sales: $<span id="totalSoldSales">0.00</span></p>
                <p>Close Ratio: <span id="closeRatio">0.00%</span></p>
                <p>Total Cars: <span id="totalCars">0</span></p>
                <p>Average Discovered Sales: $<span id="averageDiscoveredSales">0.00</span></p>
                <p>Average Sale: $<span id="averageSoldSales">0.00</span></p>
                <p>New Customer Calls: <span id="totalCustomerCalls">0</span></p>
                <p>Total Insurance Claims Jobs: <span id="totalInsuranceClaims">0</span></p>
                <p>Insurance Percentage of Sales: <span id="percentageOfInsuranceClaims">0.00%</span></p>
                <div class="highlighted-goal" id="remainingDailyGoalBottom">
                    Remaining Daily Goal: $<span id="remainingDailyGoalValueBottom">0.00</span>
                </div>
            </div>

        </form>

        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-content-center p-4 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <h3 class="text-xl font-semibold text-gray-800 mb-4" id="messageBoxTitle"></h3>
                <p class="text-gray-700 mb-6" id="messageBoxContent"></p>
                <button onclick="closeMessageBox()" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <script>
        let callEntryCount = 1;
        let carEntryCount = 1;
        const baseDailyGoal = 5200; // Define the base daily goal here

        // Function to set the current date
        function setCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('reportDate').value = `${year}-${month}-${day}`;
        }

        // Function to get the date in MMDDYY format for filename
        function getFormattedDateForFilename() {
            const today = new Date();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const yy = String(today.getFullYear()).slice(-2); // Get last two digits of the year
            return `${mm}${dd}${yy}`;
        }

        // Function to update the daily goal based on prior day's total (now as carry-over)
        function updateDailyGoalBasedOnPriorDay() {
            const priorDayTotal = parseFloat(document.getElementById('priorDayTotal').value) || 0;
            const dailyGoalInput = document.getElementById('dailyGoal');

            // Calculate the adjusted daily goal by ADDING the priorDayTotal
            const adjustedDailyGoal = baseDailyGoal + priorDayTotal;

            // Update the daily goal input field
            dailyGoalInput.value = adjustedDailyGoal.toFixed(2);

            // Also update the remaining goal display as it depends on the dailyGoal
            updateRemainingGoal();
        }

        // Function to update the Remaining Daily Goal display and its color
        function updateRemainingGoal() {
            const dailyGoal = parseFloat(document.getElementById('dailyGoal').value) || 0;
            let currentDaySoldSales = 0;

            document.querySelectorAll('input[name="carSoldSales[]"]').forEach(input => {
                currentDaySoldSales += parseFloat(input.value) || 0;
            });

            const remainingGoal = dailyGoal - currentDaySoldSales;

            const remainingGoalValueTop = document.getElementById('remainingDailyGoalValueTop');
            const remainingGoalValueBottom = document.getElementById('remainingDailyGoalValueBottom');
            const remainingGoalContainerTop = document.getElementById('remainingDailyGoalTop');
            const remainingGoalContainerBottom = document.getElementById('remainingDailyGoalBottom');

            remainingGoalValueTop.innerText = remainingGoal.toFixed(2);
            remainingGoalValueBottom.innerText = remainingGoal.toFixed(2);

            if (remainingGoal <= 0) {
                remainingGoalContainerTop.classList.remove('goal-not-met');
                remainingGoalContainerTop.classList.add('goal-met');
                remainingGoalContainerBottom.classList.remove('goal-not-met');
                remainingGoalContainerBottom.classList.add('goal-met');
            } else {
                remainingGoalContainerTop.classList.remove('goal-met');
                remainingGoalContainerTop.classList.add('goal-not-met');
                remainingGoalContainerBottom.classList.remove('goal-met');
                remainingGoalContainerBottom.classList.add('goal-not-met');
            }
        }

        // Function to calculate totals for a single car row
        function updateCarRowTotals(rowElement) {
            const discoveredInput = rowElement.querySelector('input[name="carDiscoveredSales[]"]');
            const soldInput = rowElement.querySelector('input[name="carSoldSales[]"]');
            const insuranceClaimCheckbox = rowElement.querySelector('input[name="carInsuranceClaim[]"]');
            const insuranceSoldInput = rowElement.querySelector('input[name="carInsuranceSold[]"]');
            const customerPaySoldInput = rowElement.querySelector('input[name="carCustomerPaySold[]"]');
            const individualCloseRatioInput = rowElement.querySelector('input[name="carIndividualCloseRatio[]"]');

            const discovered = parseFloat(discoveredInput?.value || '0');
            let sold = 0;

            if (insuranceClaimCheckbox?.checked) {
                const insuranceSold = parseFloat(insuranceSoldInput?.value || '0');
                const customerPaySold = parseFloat(customerPaySoldInput?.value || '0');
                sold = insuranceSold + customerPaySold;
                if (soldInput) {
                    soldInput.value = sold.toFixed(2);
                    soldInput.setAttribute('readonly', true);
                }
            } else {
                sold = parseFloat(soldInput?.value || '0');
                if (soldInput) {
                    soldInput.removeAttribute('readonly');
                }
            }

            let individualConversionRate = 0;
            if (discovered > 0) {
                individualConversionRate = (sold / discovered) * 100;
            }
            if (individualCloseRatioInput) {
                individualCloseRatioInput.value = individualConversionRate.toFixed(2) + '%';

                individualCloseRatioInput.classList.remove('conversion-met', 'conversion-not-met');
                if (individualConversionRate >= 50) {
                    individualCloseRatioInput.classList.add('conversion-met');
                } else {
                    individualCloseRatioInput.classList.add('conversion-not-met');
                }
            }
        }

        // Function to update the running totals (Discovered, Sold, Close Ratio, Insurance Claims)
        function updateRunningTotals() {
            let totalDiscovered = 0;
            let totalSold = 0;
            let numberOfCars = 0;
            const totalCustomerCalls = document.querySelectorAll('#callEntries .form-row').length;
            let totalInsuranceClaims = 0;

            document.querySelectorAll('#carSalesEntries .form-row').forEach((row) => {
                const discoveredInput = row.querySelector('input[name="carDiscoveredSales[]"]');
                const soldInput = row.querySelector('input[name="carSoldSales[]"]');
                const insuranceClaimCheckbox = row.querySelector('input[name="carInsuranceClaim[]"]');
                const individualCloseRatioInput = row.querySelector('input[name="carIndividualCloseRatio[]"]');

                if (!discoveredInput || !soldInput || !individualCloseRatioInput) {
                    console.warn('Skipping malformed or incomplete car entry row (missing critical inputs):', row);
                    return;
                }

                numberOfCars++;

                updateCarRowTotals(row);

                const discovered = parseFloat(discoveredInput.value || '0');
                const sold = parseFloat(soldInput.value || '0');

                totalDiscovered += discovered;
                totalSold += sold;

                if (insuranceClaimCheckbox?.checked) {
                    totalInsuranceClaims++;
                }
            });

            const closeRatio = totalDiscovered > 0 ? (totalSold / totalDiscovered * 100) : 0;
            const averageDiscoveredSales = numberOfCars > 0 ? (totalDiscovered / numberOfCars) : 0;
            const averageSoldSales = numberOfCars > 0 ? (totalSold / numberOfCars) : 0;
            const percentageOfInsuranceClaims = numberOfCars > 0 ? (totalInsuranceClaims / numberOfCars * 100) : 0;

            document.getElementById('totalDiscoveredSales').innerText = totalDiscovered.toFixed(2);
            document.getElementById('totalSoldSales').innerText = totalSold.toFixed(2);
            document.getElementById('closeRatio').innerText = closeRatio.toFixed(2) + '%';
            document.getElementById('totalCars').innerText = numberOfCars;
            document.getElementById('averageDiscoveredSales').innerText = averageDiscoveredSales.toFixed(2);
            document.getElementById('averageSoldSales').innerText = averageSoldSales.toFixed(2);
            document.getElementById('totalCustomerCalls').innerText = totalCustomerCalls;
            document.getElementById('totalInsuranceClaims').innerText = totalInsuranceClaims;
            document.getElementById('percentageOfInsuranceClaims').innerText = percentageOfInsuranceClaims.toFixed(2) + '%';

            updateRemainingGoal();
        }

        // Function to toggle visibility of insurance sold fields
        function toggleInsuranceFields(rowElement) {
            const insuranceClaimCheckbox = rowElement.querySelector('input[name="carInsuranceClaim[]"]');
            const insurancePayCustomerPayGroup = rowElement.querySelector('[id^="insurancePayCustomerPayGroup_"]');
            const soldInput = rowElement.querySelector('input[name="carSoldSales[]"]');

            if (insuranceClaimCheckbox && insurancePayCustomerPayGroup && soldInput) {
                if (insuranceClaimCheckbox.checked) {
                    insurancePayCustomerPayGroup.style.display = 'flex';
                    soldInput.setAttribute('readonly', true);
                } else {
                    insurancePayCustomerPayGroup.style.display = 'none';
                    soldInput.removeAttribute('readonly');
                    const insuranceSoldInput = rowElement.querySelector('input[name="carInsuranceSold[]"]');
                    const customerPaySoldInput = rowElement.querySelector('input[name="carCustomerPaySold[]"]');
                    if (insuranceSoldInput) insuranceSoldInput.value = '';
                    if (customerPaySoldInput) customerPaySoldInput.value = '';
                }
                updateCarRowTotals(rowElement);
            }
        }

        function addCallEntry() {
            callEntryCount++;
            const callEntriesDiv = document.getElementById('callEntries');
            const newEntry = document.createElement('div');
            newEntry.className = 'form-row items-end';
            newEntry.innerHTML = `
                <div class="form-col">
                    <label for="callCustomerName_${callEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Customer Name</label>
                    <input type="text" id="callCustomerName_${callEntryCount}" name="callCustomerName[]" placeholder="Customer Name" class="w-full rounded-md">
                </div>
                <div class="form-col">
                    <label for="callCustomerPhone_${callEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Phone Number</label>
                    <input type="text" id="callCustomerPhone_${callEntryCount}" name="callCustomerPhone[]" placeholder="(XXX) XXX-XXXX" class="w-full rounded-md" oninput="formatPhoneNumber(this)">
                </div>
                <div class="form-col flex items-center">
                    <input type="checkbox" id="callBookedAppointment_${callEntryCount}" name="callBookedAppointment[]" class="mr-2" onchange="toggleCallFieldsVisibility(${callEntryCount})">
                    <label for="callBookedAppointment_${callEntryCount}" class="text-gray-700 text-sm font-medium">Booked Appointment?</label>
                </div>
                <div class="form-col flex items-center">
                    <input type="checkbox" id="callLostLead_${callEntryCount}" name="callLostLead[]" class="mr-2" onchange="toggleCallFieldsVisibility(${callEntryCount})">
                    <label for="callLostLead_${callEntryCount}" class="text-gray-700 text-sm font-medium">Lost Lead?</label>
                </div>
                <div class="form-col" id="callLostCostContainer_${callEntryCount}" style="display:none;">
                    <label for="callLostCost_${callEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Estimated Lost Cost ($)</label>
                    <input type="number" id="callLostCost_${callEntryCount}" name="callLostCost[]" placeholder="e.g., 250" class="w-full rounded-md" min="0" step="0.01">
                </div>
                <div class="form-col" id="callReasonContainer_${callEntryCount}" style="display:none;">
                    <label for="callReason_${callEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Reason for Loss</label>
                    <select id="callReason_${callEntryCount}" name="callReason[]" class="w-full rounded-md" onchange="toggleOtherReason(this, ${callEntryCount}, 'call')">
                        <option value="">Select Reason</option>
                        <option value="Cost">Cost</option>
                        <option value="Appointment Availability">Appointment Availability</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-col" id="callSourceContainer_${callEntryCount}" style="display:none;">
                    <label for="callSource_${callEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Source</label>
                    <select id="callSource_${callEntryCount}" name="callSource[]" class="w-full rounded-md">
                        <option value="">Select Source</option>
                        <option value="Referral">Referral</option>
                        <option value="Repair Pal">Repair Pal</option>
                        <option value="Google">Google</option>
                        <option value="Social Media">Social Media</option>
                    </select>
                </div>
                <div class="w-full sm:w-auto">
                    <button type="button" onclick="removeCallEntry(this)" class="btn-remove">Remove</button>
                </div>
                <div class="form-col w-full" id="callOtherReasonContainer_${callEntryCount}" style="display:none;">
                    <label for="callOtherReason_${callEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Other Reason Details</label>
                    <textarea id="callOtherReason_${callEntryCount}" name="callOtherReason[]" rows="2" placeholder="Please specify other reason" class="w-full rounded-md"></textarea>
                </div>
            `;
            callEntriesDiv.appendChild(newEntry);
            updateRemoveButtonsVisibility('callEntries');
            updateRunningTotals();
            toggleCallFieldsVisibility(callEntryCount);
        }

        function removeCallEntry(button) {
            button.closest('.form-row').remove();
            updateRemoveButtonsVisibility('callEntries');
            updateRunningTotals();
        }

        function addCarEntry() {
            carEntryCount++;
            const carSalesEntriesDiv = document.getElementById('carSalesEntries');
            const newEntry = document.createElement('div');
            newEntry.className = 'form-row items-end';
            newEntry.innerHTML = `
                <div class="form-col">
                    <label for="carRepairOrderNumber_${carEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">RO#</label>
                    <input type="text" id="carRepairOrderNumber_${carEntryCount}" name="carRepairOrderNumber[]" placeholder="RO Number" class="w-full rounded-md">
                </div>
                <div class="form-col">
                    <label for="carLastName_${carEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Last Name</label>
                    <input type="text" id="carLastName_${carEntryCount}" name="carLastName[]" placeholder="Customer Last Name" class="w-full rounded-md">
                </div>
                <div class="form-col">
                    <label for="carDiscoveredSales_${carEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Discovered ($)</label>
                    <input type="number" id="carDiscoveredSales_${carEntryCount}" name="carDiscoveredSales[]" placeholder="e.g., 500" class="w-full rounded-md" min="0" step="0.01" oninput="updateRunningTotals()">
                </div>
                <div class="form-col">
                    <label for="carSoldSales_${carEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Sold ($)</label>
                    <input type="number" id="carSoldSales_${carEntryCount}" name="carSoldSales[]" placeholder="e.g., 350" class="w-full rounded-md" min="0" step="0.01" oninput="updateRemainingGoal(); updateRunningTotals()">
                </div>
                <div class="form-col">
                    <label for="carIndividualCloseRatio_${carEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Close Ratio (%)</label>
                    <input type="text" id="carIndividualCloseRatio_${carEntryCount}" name="carIndividualCloseRatio[]" class="w-full rounded-md" readonly>
                </div>
                <div class="form-col flex items-center pt-6">
                    <input type="checkbox" id="carAppointmentScheduled_${carEntryCount}" name="carAppointmentScheduled[]" class="mr-2" onchange="updateRunningTotals()">
                    <label for="carAppointmentScheduled_${carEntryCount}" class="text-gray-700 text-sm font-medium">Future Appointment Scheduled?</label>
                </div>
                <div class="form-col flex items-center pt-6">
                    <input type="checkbox" id="carInsuranceClaim_${carEntryCount}" name="carInsuranceClaim[]" class="mr-2" onchange="toggleInsuranceFields(this.closest('.form-row'))">
                    <label for="carInsuranceClaim_${carEntryCount}" class="text-gray-700 text-sm font-medium">Insurance Claim</label>
                </div>
                <div class="form-row w-full" id="insurancePayCustomerPayGroup_${carEntryCount}" style="display:none;">
                    <div class="form-col">
                        <label for="carInsuranceSold_${carEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Insurance Sold ($)</label>
                        <input type="number" id="carInsuranceSold_${carEntryCount}" name="carInsuranceSold[]" placeholder="e.g., 200" class="w-full rounded-md" min="0" step="0.01" oninput="updateCarRowTotals(this.closest('.form-row')); updateRunningTotals()">
                    </div>
                    <div class="form-col">
                        <label for="carCustomerPaySold_${carEntryCount}" class="block text-gray-700 text-sm font-medium mb-1">Customer Pay Sold ($)</label>
                        <input type="number" id="carCustomerPaySold_${carEntryCount}" name="carCustomerPaySold[]" placeholder="e.g., 150" class="w-full rounded-md" min="0" step="0.01" oninput="updateCarRowTotals(this.closest('.form-row')); updateRunningTotals()">
                    </div>
                </div>
                <div class="w-full sm:w-auto">
                    <button type="button" onclick="removeCarEntry(this)" class="btn-remove">Remove</button>
                </div>
            `;
            carSalesEntriesDiv.appendChild(newEntry);
            updateRemoveButtonsVisibility('carSalesEntries');
            updateRemainingGoal();
            updateRunningTotals();
            toggleInsuranceFields(newEntry);
        }

        function removeCarEntry(button) {
            button.closest('.form-row').remove();
            updateRemoveButtonsVisibility('carSalesEntries');
            updateRemainingGoal();
            updateRunningTotals();
        }

        function toggleOtherReason(selectElement, index, type) {
            const otherReasonContainer = document.getElementById(`${type}OtherReasonContainer_${index}`);
            if (selectElement.value === 'Other') {
                otherReasonContainer.style.display = 'block';
            } else {
                otherReasonContainer.style.display = 'none';
                document.getElementById(`${type}OtherReason_${index}`).value = '';
            }
        }

        function toggleCallFieldsVisibility(index) {
            const bookedCheckbox = document.getElementById(`callBookedAppointment_${index}`);
            const lostLeadCheckbox = document.getElementById(`callLostLead_${index}`);

            const lostCostContainer = document.getElementById(`callLostCostContainer_${index}`);
            const reasonContainer = document.getElementById(`callReasonContainer_${index}`);
            const sourceContainer = document.getElementById(`callSourceContainer_${index}`);
            const otherReasonContainer = document.getElementById(`callOtherReasonContainer_${index}`);

            if (lostLeadCheckbox && lostCostContainer && reasonContainer) {
                if (lostLeadCheckbox.checked) {
                    lostCostContainer.style.display = 'block';
                    reasonContainer.style.display = 'block';
                    lostCostContainer.classList.add('w-full');
                    reasonContainer.classList.add('w-full');

                    const reasonSelect = document.getElementById(`callReason_${index}`);
                    if (reasonSelect && reasonSelect.value === 'Other') {
                        if (otherReasonContainer) otherReasonContainer.style.display = 'block';
                    }
                    if (bookedCheckbox && bookedCheckbox.checked) {
                        bookedCheckbox.checked = false;
                        if (sourceContainer) sourceContainer.style.display = 'none';
                        if (document.getElementById(`callSource_${index}`)) document.getElementById(`callSource_${index}`).value = '';
                        sourceContainer.classList.remove('w-full');
                    }
                } else {
                    lostCostContainer.style.display = 'none';
                    reasonContainer.style.display = 'none';
                    if (otherReasonContainer) otherReasonContainer.style.display = 'none';
                    lostCostContainer.classList.remove('w-full');
                    reasonContainer.classList.remove('w-full');

                    if (document.getElementById(`callLostCost_${index}`)) document.getElementById(`callLostCost_${index}`).value = '';
                    if (document.getElementById(`callReason_${index}`)) document.getElementById(`callReason_${index}`).value = '';
                    if (document.getElementById(`callOtherReason_${index}`)) document.getElementById(`callOtherReason_${index}`).value = '';
                }
            }

            if (bookedCheckbox && sourceContainer) {
                if (bookedCheckbox.checked) {
                    sourceContainer.style.display = 'block';
                    sourceContainer.classList.add('w-full');

                    if (lostLeadCheckbox && lostLeadCheckbox.checked) {
                        lostLeadCheckbox.checked = false;
                        if (lostCostContainer) lostCostContainer.style.display = 'none';
                        if (reasonContainer) reasonContainer.style.display = 'none';
                        if (otherReasonContainer) otherReasonContainer.style.display = 'none';
                        if (document.getElementById(`callLostCost_${index}`)) document.getElementById(`callLostCost_${index}`).value = '';
                        if (document.getElementById(`callReason_${index}`)) document.getElementById(`callReason_${index}`).value = '';
                        if (document.getElementById(`callOtherReason_${index}`)) document.getElementById(`callOtherReason_${index}`).value = '';
                        lostCostContainer.classList.remove('w-full');
                        reasonContainer.classList.remove('w-full');
                    }
                } else {
                    sourceContainer.style.display = 'none';
                    sourceContainer.classList.remove('w-full');
                    if (document.getElementById(`callSource_${index}`)) document.getElementById(`callSource_${index}`).value = '';
                }
            }
        }

        function updateRemoveButtonsVisibility(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const removeButtons = container.querySelectorAll('.form-row .btn-remove');
            if (removeButtons.length <= 1) {
                removeButtons.forEach(btn => btn.classList.add('hidden'));
            } else {
                removeButtons.forEach(btn => btn.classList.remove('hidden'));
            }
        }

        async function savePageAsImage() {
            showMessageBox('Generating Image...', 'Please wait while the form is converted to an image.');

            const formContainer = document.querySelector('.container');
            const originalOverflow = document.body.style.overflow;
            document.body.style.overflow = 'auto';

            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(formContainer, {
                        scale: 2,
                        useCORS: true,
                        windowWidth: formContainer.scrollWidth,
                        windowHeight: formContainer.scrollHeight,
                        scrollX: -window.scrollX,
                        scrollY: -window.scrollY,
                    });

                    const imgDataUrl = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = imgDataUrl;
                    a.download = `DailySalesForm_${getFormattedDateForFilename()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    closeMessageBox();
                } catch (error) {
                    console.error('Error generating image:', error);
                    showMessageBox('Error', 'Failed to generate image. Please try again.');
                } finally {
                    document.body.style.overflow = originalOverflow;
                }
            }, 100);
        }


        async function generatePdfAndSubmit(event) {
            event.preventDefault();

            showMessageBox('Generating PDF & Submitting...', 'Please wait while the report is prepared and submitted.');

            const formContainer = document.querySelector('.container');
            const originalOverflow = document.body.style.overflow;
            document.body.style.overflow = 'auto';

            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(formContainer, {
                        scale: 2,
                        useCORS: true,
                        windowWidth: formContainer.scrollWidth,
                        windowHeight: formContainer.scrollHeight,
                        scrollX: -window.scrollX,
                        scrollY: -window.scrollY,
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');

                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    const pdfData = pdf.output('datauristring');
                    document.getElementById('pdfData').value = pdfData;

                    const formDataCollected = {
                        reportDate: document.getElementById('reportDate').value,
                        serviceAdvisorName: document.getElementById('serviceAdvisorName').value,
                        dailyGoal: parseFloat(document.getElementById('dailyGoal').value) || 0,
                        priorDayTotal: parseFloat(document.getElementById('priorDayTotal').value) || 0,
                        carSales: [],
                        customerLeads: [],
                        totals: {
                            totalDiscoveredSales: parseFloat(document.getElementById('totalDiscoveredSales').innerText) || 0,
                            totalSoldSales: parseFloat(document.getElementById('totalSoldSales').innerText) || 0,
                            closeRatio: document.getElementById('closeRatio').innerText,
                            totalCars: parseInt(document.getElementById('totalCars').innerText) || 0,
                            averageDiscoveredSales: parseFloat(document.getElementById('averageDiscoveredSales').innerText) || 0,
                            averageSoldSales: parseFloat(document.getElementById('averageSoldSales').innerText) || 0,
                            newCustomerCalls: parseInt(document.getElementById('totalCustomerCalls').innerText) || 0,
                            totalInsuranceClaims: parseInt(document.getElementById('totalInsuranceClaims').innerText) || 0,
                            percentageOfInsuranceClaims: document.getElementById('percentageOfInsuranceClaims').innerText,
                            remainingDailyGoal: parseFloat(document.getElementById('remainingDailyGoalValueBottom').innerText) || 0,
                        }
                    };

                    document.querySelectorAll('#carSalesEntries .form-row').forEach(row => {
                        const roNum = row.querySelector('input[name="carRepairOrderNumber[]"]')?.value || '';
                        const lastName = row.querySelector('input[name="carLastName[]"]')?.value || '';
                        const discovered = parseFloat(row.querySelector('input[name="carDiscoveredSales[]"]')?.value || '0');
                        const sold = parseFloat(row.querySelector('input[name="carSoldSales[]"]')?.value || '0');
                        const individualCloseRatio = row.querySelector('input[name="carIndividualCloseRatio[]"]')?.value || '';
                        const appointmentScheduled = row.querySelector('input[name="carAppointmentScheduled[]"]')?.checked || false;
                        const insuranceClaim = row.querySelector('input[name="carInsuranceClaim[]"]')?.checked || false;
                        const insuranceSold = parseFloat(row.querySelector('input[name="carInsuranceSold[]"]')?.value || '0');
                        const customerPaySold = parseFloat(row.querySelector('input[name="carCustomerPaySold[]"]')?.value || '0');

                        if (roNum || lastName || discovered > 0 || sold > 0 || appointmentScheduled || insuranceClaim || insuranceSold > 0 || customerPaySold > 0) {
                            formDataCollected.carSales.push({
                                repairOrderNumber: roNum,
                                lastName: lastName,
                                discoveredSales: discovered,
                                soldSales: sold,
                                individualCloseRatio: individualCloseRatio,
                                appointmentScheduled: appointmentScheduled,
                                insuranceClaim: insuranceClaim,
                                insuranceSold: insuranceSold,
                                customerPaySold: customerPaySold
                            });
                        }
                    });

                    document.querySelectorAll('#callEntries .form-row').forEach(row => {
                        const customerName = row.querySelector('input[name="callCustomerName[]"]')?.value || '';
                        const customerPhone = row.querySelector('input[name="callCustomerPhone[]"]')?.value || '';
                        const bookedAppointment = row.querySelector('input[name="callBookedAppointment[]"]')?.checked || false;
                        const lostLead = row.querySelector('input[name="callLostLead[]"]')?.checked || false;
                        const lostCost = parseFloat(row.querySelector('input[name="callLostCost[]"]')?.value || '0');
                        const reason = row.querySelector('select[name="callReason[]"]')?.value || '';
                        const otherReasonDetails = row.querySelector('textarea[name="callOtherReason[]"]')?.value || '';
                        const source = row.querySelector('select[name="callSource[]"]')?.value || '';

                        if (customerName || customerPhone || bookedAppointment || lostLead || lostCost > 0 || reason || source) {
                            formDataCollected.customerLeads.push({
                                customerName: customerName,
                                customerPhone: customerPhone,
                                bookedAppointment: bookedAppointment,
                                lostLead: lostLead,
                                lostCost: lostCost,
                                reason: reason,
                                otherReasonDetails: (reason === 'Other' && otherReasonDetails) ? otherReasonDetails : '',
                                source: source
                            });
                        }
                    });

                    document.getElementById('formDataJson').value = JSON.stringify(formDataCollected, null, 2);

                    document.getElementById('salesForm').submit();

                } catch (error) {
                    console.error('Error generating PDF or submitting form:', error);
                    showMessageBox('Error', 'Failed to generate PDF or submit form. Please try again.');
                } finally {
                    document.body.style.overflow = originalOverflow;
                }
            }, 100);
        }


        // Initial calls to set button visibility and calculate goal on page load
        document.addEventListener('DOMContentLoaded', () => {
            setCurrentDate();
            updateRemoveButtonsVisibility('callEntries');
            updateRemoveButtonsVisibility('carSalesEntries');
            updateDailyGoalBasedOnPriorDay();
            updateRunningTotals();

            document.querySelectorAll('#callEntries .form-row').forEach((row, index) => {
                toggleCallFieldsVisibility(index + 1);
            });

            document.querySelectorAll('#carSalesEntries .form-row').forEach((row) => {
                toggleInsuranceFields(row);
            });
        });


        // Function to show a custom message box
        function showMessageBox(title, message) {
            document.getElementById('messageBoxTitle').innerText = title;
            document.getElementById('messageBoxContent').innerText = message;
            document.getElementById('messageBox').classList.remove('hidden');
        }

        // Function to close the custom message box
        function closeMessageBox() {
            document.getElementById('messageBox').classList.add('hidden');
        }

        // Phone number formatting function
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            let formattedValue = '';

            if (value.length > 0) {
                formattedValue += '(' + value.substring(0, 3);
            }
            if (value.length >= 4) {
                formattedValue += ') ' + value.substring(3, 6);
            }
            if (value.length >= 7) {
                formattedValue += '-' + value.substring(6, 10);
            }
            input.value = formattedValue;
        }

        // The form's submit event listener is now handled by generatePdfAndSubmit
        // document.getElementById('salesForm').addEventListener('submit', async function(event) { ... });
    </script>
</body>
</html>
