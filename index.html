<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Added 'dark' class to enable dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme changes */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better form visibility */
            min-height: 100vh;
            padding: 2rem;
        }

        /* Light Mode Defaults (if 'dark' class is not present on html tag) - Unchanged */
        body {
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark text */
        }
        .container {
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        input[type="text"], input[type="number"], textarea, select, input[type="date"] {
            border: 1px solid #d1d5db;
            background-color: #ffffff;
            color: #1f2937;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus, input[type="date"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .section-title {
            border-bottom: 2px solid #e5e7eb;
            color: #374151;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-remove {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-remove:hover {
            background-color: #dc2626;
        }
        .goal-display {
            background-color: #e0f2fe; /* light blue */
            border-left-color: #38b2ac; /* teal */
            color: #1a202c;
        }
        .totals-section {
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
        }
        .totals-section p {
            color: #1e3a8a;
        }
        .totals-section p span {
            color: #000;
        }
        .highlighted-goal {
            background-color: #e0f2fe; /* light blue */
            border-color: #38b2ac; /* teal */
            color: #1a202c;
        }
        input.conversion-met {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
            color: #16a34a; /* green-700 */
        }
        input.conversion-not-met {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
            color: #dc2626; /* red-700 */
        }
        .message-box-content, .confirmation-content {
            background-color: #ffffff;
            color: #374151;
        }
        .confirmation-content h3 {
            color: #1f2937;
        }
        .confirmation-buttons .btn-confirm {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .confirmation-buttons .btn-confirm:hover {
            background-color: #2563eb;
        }
        .confirmation-buttons .btn-cancel {
            background-color: #e5e7eb;
            color: #374151;
        }
        .confirmation-buttons .btn-cancel:hover {
            background-color: #d1d5db;
        }


        /* NEW Dark Mode Overrides (when 'dark' class is present on html tag) */
        html.dark body {
            background-color: #1a202c; /* Deeper, less saturated dark blue/gray */
            color: #e2e8f0; /* Lighter off-white text */
        }
        html.dark .container {
            background-color: #2d3748; /* Slightly lighter than body background */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); /* More prominent shadow */
        }
        html.dark input[type="text"], html.dark input[type="number"], html.dark textarea, html.dark select, html.dark input[type="date"] {
            border: 1px solid #4a5568; /* Slightly darker border */
            background-color: #4a5568; /* Darker input background */
            color: #e2e8f0; /* Light text */
        }
        html.dark input[type="text"]:focus, html.dark input[type="number"]:focus, html.dark textarea:focus, html.dark select:focus, html.dark input[type="date"]:focus {
            border-color: #63b3ed; /* Brighter blue focus */
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.4); /* Matching focus shadow */
        }
        html.dark .section-title {
            border-bottom: 2px solid #4a5568; /* Darker border */
            color: #cbd5e0; /* Lighter text */
        }
        /* UPDATED BUTTON COLORS FOR DARK MODE */
        html.dark .btn-primary {
            background-color: #3a4780; /* Muted indigo/blue */
            color: #ffffff; /* white text */
        }
        html.dark .btn-primary:hover {
            background-color: #2c3a6b; /* darker muted indigo/blue on hover */
        }
        html.dark .btn-remove {
            background-color: #c53030; /* dark red */
            color: #ffffff; /* white text */
        }
        html.dark .btn-remove:hover {
            background-color: #9b2c2c; /* darker red on hover */
        }
        /* END UPDATED BUTTON COLORS */

        html.dark .goal-display {
            background-color: #2d3748; /* Same as container for subtlety */
            border-left-color: #48bb78; /* Muted green border */
            color: #e2e8f0;
        }
        html.dark .goal-met {
            color: #48bb78; /* Muted green */
            background-color: #2f855a; /* Darker green background */
            border-color: #48bb78; /* Muted green border */
        }
        html.dark .goal-not-met {
            color: #fc8181; /* Muted red */
            background-color: #9b2c2c; /* Darker red background */
            border-color: #fc8181; /* Muted red border */
        }
        html.dark .totals-section {
            background-color: #2d3748; /* Same as container */
            border: 1px solid #4a5568; /* Darker border */
        }
        html.dark .totals-section p {
            color: #cbd5e0; /* Lighter text */
        }
        html.dark .totals-section p span {
            color: #e2e8f0; /* Very light for values */
        }
        html.dark .highlighted-goal {
            background-color: #2d3748;
            border-color: #48bb78;
            color: #e2e8f0;
        }
        html.dark input.conversion-met {
            background-color: #2f855a; /* Darker green */
            border-color: #48bb78; /* Muted green */
            color: #48bb78; /* Muted green */
        }
        html.dark input.conversion-not-met {
            background-color: #9b2c2c; /* Darker red */
            border-color: #fc8181; /* Muted red */
            color: #fc8181; /* Muted red */
        }
        html.dark .message-box-content,
        html.dark .confirmation-content {
            background-color: #2d3748; /* Darker content background */
            color: #e2e8f0;
        }
        html.dark .confirmation-content h3 {
            color: #e2e8f0;
        }
        html.dark .confirmation-buttons .btn-cancel {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        html.dark .confirmation-buttons .btn-cancel:hover {
            background-color: #646b76;
        }

        /* Flexbox and width for responsive columns */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .form-col {
            flex: 1;
            min-width: 180px;
        }
        @media (min-width: 640px) {
            .form-row > div {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-8">
            <!-- Consider using a dark mode friendly logo or a CSS filter for contrast -->
            <img src="https://raw.githubusercontent.com/Mazdasplus/Daily-sales-form/main/IMG_5685.png" alt="Mazda's Plus Logo" style="max-width: 200px; height: auto; margin: 0 auto; filter: invert(0.8) hue-rotate(180deg) saturate(1.2);">
        </div>
        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">Daily Sales Form</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-8 text-center">Track your daily performance as an automotive service writer.</p>

        <form id="salesForm" class="space-y-8" action="https://formspree.io/f/xrbqnjwe" method="POST">
            <div class="form-row mb-4">
                <div class="form-col">
                    <label for="reportDate" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Date</label>
                    <input type="date" id="reportDate" name="reportDate" class="w-full rounded-md">
                </div>
                <div class="form-col">
                    <label for="serviceAdvisorName" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Service Advisor Name</label>
                    <select id="serviceAdvisorName" name="serviceAdvisorName" class="w-full rounded-md">
                        <option value="Beto Calderon">Beto Calderon</option>
                        <option value="Scott Carvalho">Scott Carvalho</option>
                    </select>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-100 section-title">Sales Metrics</h2>

                <div class="form-row mb-4">
                    <div class="form-col">
                        <label for="priorDayTotal" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Prior Day Total ($)</label>
                        <input type="number" id="priorDayTotal" name="priorDayTotal" placeholder="e.g., -200" class="w-full rounded-md" step="0.01" oninput="updateDailyGoalBasedOnPriorDay()">
                    </div>
                    <div class="form-col">
                        <label for="dailyGoal" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Daily Goal ($)</label>
                        <input type="number" id="dailyGoal" name="dailyGoal" class="w-full rounded-md" min="0" step="0.01" oninput="updateRemainingGoal()">
                    </div>
                </div>

                <div class="goal-display" id="remainingDailyGoalTop">
                    Remaining Daily Goal: $<span id="remainingDailyGoalValueTop">0.00</span>
                </div>

                <div class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-600 mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-100">Individual Car Sales</h3>
                    <div id="carSalesEntries" class="space-y-4">
                        <div class="form-row items-end">
                            <div class="form-col">
                                <label for="carRepairOrderNumber_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">RO#</label>
                                <input type="text" id="carRepairOrderNumber_1" name="carRepairOrderNumber[]" placeholder="RO Number" class="w-full rounded-md">
                            </div>
                            <div class="form-col">
                                <label for="carLastName_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Last Name</labeL>
                                <input type="text" id="carLastName_1" name="carLastName[]" placeholder="Customer Last Name" class="w-full rounded-md">
                            </div>
                            <div class="form-col">
                                <label for="carDiscoveredSales_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Total Discovered ($)</label>
                                <input type="number" id="carDiscoveredSales_1" name="carDiscoveredSales[]" placeholder="e.g., 500" class="w-full rounded-md" min="0" step="0.01">
                            </div>

                            <div class="w-full flex flex-wrap items-center gap-4 mt-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="carHasInsurancePortion_1" name="carHasInsurancePortion[]" class="mr-2">
                                    <label for="carHasInsurancePortion_1" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Has Insurance Portion?</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="carAppointmentScheduled_1" name="carAppointmentScheduled[]" class="mr-2">
                                    <label for="carAppointmentScheduled_1" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Future Appointment Scheduled?</label>
                                </div>
                            </div>

                            <div class="form-col w-full" id="carInsurancePortionContainer_1" style="display:none;">
                                <label class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Insurance Sold ($)</label>
                                <input type="number" id="carInsuranceSold_1" name="carInsuranceSold[]" placeholder="Sold ($)" class="w-full rounded-md" min="0" step="0.01">
                            </div>

                            <div class="flex items-center mt-2" id="carCustomerPayCheckboxContainer_1" style="display:none;"> <input type="checkbox" id="carHasCustomerPayPortion_1" name="carHasCustomerPayPortion[]" class="mr-2">
                                <label for="carHasCustomerPayPortion_1" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Has Customer Pay Portion?</label>
                            </div>
                            <div class="form-col w-full" id="carCustomerPayPortionContainer_1" style="display:none;">
                                <label class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Customer Pay Sold ($)</label>
                                <input type="number" id="carCustomerPaySold_1" name="carCustomerPaySold[]" placeholder="Sold ($)" class="w-full rounded-md" min="0" step="0.01">
                            </div>

                            <!-- CORRECTED: Changed 'form-row' to a plain 'div' with flex classes -->
                            <div class="flex flex-wrap w-full mt-2 gap-4">
                                <div class="form-col">
                                    <label for="carTotalSold_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Total Sold ($)</label>
                                    <input type="number" id="carTotalSold_1" name="carTotalSold[]" class="w-full rounded-md">
                                </div>
                                <div class="form-col">
                                    <label for="carIndividualCloseRatio_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Close Ratio (%)</label>
                                    <input type="text" id="carIndividualCloseRatio_1" name="carIndividualCloseRatio[]" class="w-full rounded-md" readonly>
                                </div>
                            </div>

                            <div class="w-full sm:w-auto">
                                <button type="button" onclick="removeCarEntry(this)" class="btn-remove hidden">Remove</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addCarEntry()" class="btn-primary text-sm mt-4">Add Another Car</button>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-100 section-title">New Customer Leads</h2>
                <div id="callEntries" class="space-y-4">
                    <div class="form-row items-end">
                        <div class="form-col">
                            <label for="callCustomerName_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Customer Name</label>
                            <input type="text" id="callCustomerName_1" name="callCustomerName[]" placeholder="Customer Name" class="w-full rounded-md">
                        </div>
                        <div class="form-col">
                            <label for="callCustomerPhone_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Phone Number</label>
                            <input type="text" id="callCustomerPhone_1" name="callCustomerPhone[]" placeholder="(XXX) XXX-XXXX" class="w-full rounded-md" oninput="formatPhoneNumber(this)">
                        </div>
                        <div class="form-col flex items-center">
                            <input type="checkbox" id="callBookedAppointment_1" name="callBookedAppointment[]" class="mr-2" onchange="toggleCallFieldsVisibility(1)">
                            <label for="callBookedAppointment_1" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Booked Appointment?</label>
                        </div>
                        <div class="form-col flex items-center">
                            <input type="checkbox" id="callLostLead_1" name="callLostLead[]" class="mr-2" onchange="toggleCallFieldsVisibility(1)">
                            <label for="callLostLead_1" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Lost Lead?</label>
                        </div>
                        <div class="form-col" id="callLostCostContainer_1" style="display:none;">
                            <label for="callLostCost_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Estimated Lost Cost ($)</label>
                            <input type="number" id="callLostCost_1" name="callLostCost[]" placeholder="e.g., 250" class="w-full rounded-md" min="0" step="0.01">
                        </div>
                        <div class="form-col" id="callReasonContainer_1" style="display:none;">
                            <label for="callReason_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Reason for Loss</label>
                            <select id="callReason_1" name="callReason[]" class="w-full rounded-md" onchange="toggleOtherReason(this, 1, 'call')">
                                <option value="">Select Reason</option>
                                <option value="Cost">Cost</option>
                                <option value="Appointment Availability">Appointment Availability</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-col" id="callSourceContainer_1" style="display:none;">
                            <label for="callSource_1" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Source</label>
                            <select id="callSource_1" name="callSource[]" class="w-full rounded-md">
                                <option value="">Select Source</option>
                                <option value="Referral">Referral</option>
                                <option value="Repair Pal">Repair Pal</option>
                                <option value="Google">Google</option>
                                <option value="Social Media">Social Media</option>
                            </select>
                        </div>
                        <div class="w-full sm:w-auto">
                            <button type="button" onclick="removeCallEntry(this)" class="btn-remove">Remove</button>
                        </div>
                        <div class="form-col w-full" id="callOtherReasonContainer_1" style="display:none;">
                            <label for="callOtherReason_${callEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Other Reason Details</label>
                            <textarea id="callOtherReason_${callEntryCount}" name="callOtherReason[]" rows="2" placeholder="Please specify other reason" class="w-full rounded-md"></textarea>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addCallEntry()" class="btn-primary text-sm mt-4">Add Another Lead</button>
            </div>

            <div class="text-center mt-6 flex justify-center space-x-4">
                <button type="button" onclick="savePageAsImage()" class="btn-primary">Submit Daily Report (Save Image)</button>
            </div>

            <div class="totals-section">
                <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-100 section-title">Daily Totals</h2>
                <p class="text-gray-700 dark:text-gray-200">Total Discovered Sales: $<span id="totalDiscoveredSales" class="dark:text-gray-100">0.00</span></p>
                <p class="text-gray-700 dark:text-gray-200">Total Sold Sales: $<span id="totalSoldSales" class="dark:text-gray-100">0.00</span></p>
                <p class="text-gray-700 dark:text-gray-200">Close Ratio: <span id="closeRatio" class="dark:text-gray-100">0.00%</span></p>
                <p class="text-gray-700 dark:text-gray-200">Total Cars: <span id="totalCars" class="dark:text-gray-100">0</span></p>
                <p class="text-gray-700 dark:text-gray-200">Average Discovered Sales: $<span id="averageDiscoveredSales" class="dark:text-gray-100">0.00</span></p>
                <p class="text-gray-700 dark:text-gray-200">Average Sale: $<span id="averageSoldSales" class="dark:text-gray-100">0.00</span></p>
                <p class="text-gray-700 dark:text-gray-200">New Customer Calls: <span id="totalCustomerCalls" class="dark:text-gray-100">0</span></p>
                <p class="text-gray-700 dark:text-gray-200">Total Insurance Claims Jobs: <span id="totalInsuranceClaims" class="dark:text-gray-100">0</span></p>
                <p class="text-gray-700 dark:text-gray-200">Insurance Percentage of Sales: <span id="percentageOfInsuranceClaims" class="dark:text-gray-100">0.00%</span></p>
                <div class="highlighted-goal" id="remainingDailyGoalBottom">
                    Remaining Daily Goal: $<span id="remainingDailyGoalValueBottom">0.00</span>
                </div>
            </div>

            <!-- Hidden inputs for Formspree are still here if needed for other integrations -->
            <input type="hidden" id="hiddenTotalDiscoveredSales" name="Total Discovered Sales">
            <input type="hidden" id="hiddenTotalSoldSales" name="Total Sold Sales">
            <input type="hidden" id="hiddenCloseRatio" name="Close Ratio">
            <input type="hidden" id="hiddenRemainingDailyGoal" name="Remaining Daily Goal">
            <input type="hidden" id="hiddenTotalCars" name="Total Cars">
            <input type="hidden" id="hiddenAverageDiscoveredSales" name="Average Discovered Sales">
            <input type="hidden" id="hiddenAverageSoldSales" name="Average Sale">
            <input type="hidden" id="hiddenTotalCustomerCalls" name="New Customer Calls">
            <input type="hidden" id="hiddenTotalInsuranceClaims" name="Total Insurance Claims Jobs">
            <input type="hidden" id="hiddenPercentageOfInsuranceClaims" name="Insurance Percentage of Sales">

        </form>

        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="message-box-content p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <h3 class="text-xl font-semibold mb-4" id="messageBoxTitle"></h3>
                <p class="mb-6" id="messageBoxContent"></p>
                <button onclick="closeMessageBox()" class="btn-primary">OK</button>
            </div>
        </div>

        <div id="confirmationBox" class="confirmation-box hidden">
            <div class="confirmation-content p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <h3 id="confirmationBoxTitle" class="text-xl font-semibold mb-4"></h3>
                <p id="confirmationBoxContent" class="mb-6"></p>
                <div class="confirmation-buttons">
                    <button class="btn-confirm" onclick="confirmAction(true)">Yes</button>
                    <button class="btn-cancel" onclick="confirmAction(false)">No</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants defined at the top
        let callEntryCount = 1;
        let carEntryCount = 1;
        const baseDailyGoal = 5200; // Define the base daily goal here

        // Variables to store the context for confirmation box
        let currentDuplicateRo = null;
        let currentDuplicateLastName = null;
        let currentDuplicateRowIndex = null;
        let originalEntryIndexForCombine = null;

        // --- Core Functions for Calculations and Updates (Moved to top) ---

        // Function to update the running totals (Discovered, Sold, Close Ratio, Insurance Claims)
        function updateRunningTotals() {
            let totalDiscovered = 0;
            let totalSold = 0;
            // Get all direct children with 'form-row' class under #carSalesEntries
            const carRows = document.querySelectorAll('#carSalesEntries > .form-row');
            const numberOfCars = carRows.length;

            const totalCustomerCalls = document.querySelectorAll('#callEntries .form-row').length;
            let totalInsuranceClaims = 0; // Counter for entries with an insurance portion

            // Reset the duplicate check context
            currentDuplicateRo = null;
            currentDuplicateLastName = null;
            currentDuplicateRowIndex = null;
            originalEntryIndexForCombine = null;

            const roLastNameMap = new Map(); // Stores {combinedKey: {index: row_index, hasInsurance: bool, hasCustomerPay: bool}}

            carRows.forEach((row, index) => {
                const roInput = row.querySelector('input[name="carRepairOrderNumber[]"]');
                const lastNameInput = row.querySelector('input[name="carLastName[]"]');
                const totalDiscoveredInput = row.querySelector('input[name="carDiscoveredSales[]"]'); // Now Total Discovered for the RO
                const totalSoldInput = row.querySelector('input[name="carTotalSold[]"]'); // Now Total Sold for the RO
                const individualCloseRatioInput = row.querySelector('input[name="carIndividualCloseRatio[]"]');
                const hasInsuranceCheckbox = row.querySelector('input[name="carHasInsurancePortion[]"]');

                const ro = roInput ? roInput.value.trim() : '';
                const lastName = lastNameInput ? lastNameInput.value.trim() : '';

                // Check for duplicate RO number and Last Name
                if (ro && lastName) {
                    const combinedKey = `${ro}-${lastName}`.toLowerCase();
                    if (roLastNameMap.has(combinedKey)) {
                        // Found a duplicate, store context and show confirmation
                        currentDuplicateRo = ro;
                        currentDuplicateLastName = lastName;
                        currentDuplicateRowIndex = index; // Index of the newly typed duplicate row
                        originalEntryIndexForCombine = roLastNameMap.get(combinedKey).index; // Index of the original row

                        showConfirmationBox(
                            'Duplicate Entry Detected',
                            `RO Number "${ro}" with Last Name "${lastName}" has been entered before. ` +
                            `Do you want to combine this new entry with the existing one?`,
                            (confirmed) => {
                                if (confirmed) {
                                    combineCarEntries(originalEntryIndexForCombine, currentDuplicateRowIndex);
                                } else {
                                    showMessageBox('Entry Not Combined', 'The duplicate entry was not combined. Please review and adjust manually if needed.');
                                }
                                // Clear the context after action
                                currentDuplicateRo = null;
                                currentDuplicateLastName = null;
                                currentDuplicateRowIndex = null;
                                originalEntryIndexForCombine = null;
                            }
                        );
                        // Stop further processing of totals for now, will re-run after confirmation
                        return;
                    }
                    // Add the current combination to the map for future checks
                    roLastNameMap.set(combinedKey, {
                        index: index,
                        hasInsurance: hasInsuranceCheckbox.checked,
                    });
                }

                let rowTotalDiscovered = 0;
                if (totalDiscoveredInput) { // Explicit null check
                    rowTotalDiscovered = parseFloat(totalDiscoveredInput.value) || 0;
                }

                let rowTotalSold = 0;
                if (totalSoldInput) { // Explicit null check
                    rowTotalSold = parseFloat(totalSoldInput.value) || 0;
                }

                totalDiscovered += rowTotalDiscovered;
                totalSold += rowTotalSold;

                if (hasInsuranceCheckbox && hasInsuranceCheckbox.checked) {
                    totalInsuranceClaims++; // Increment if this entry has an insurance portion
                }

                let individualConversionRate = 0;
                if (rowTotalDiscovered > 0) {
                    individualConversionRate = (rowTotalSold / rowTotalDiscovered) * 100;
                }
                if (individualCloseRatioInput) { // Null check for individualCloseRatioInput
                    individualCloseRatioInput.value = individualConversionRate.toFixed(2) + '%';
                    individualCloseRatioInput.classList.remove('conversion-met', 'conversion-not-met');
                    if (individualConversionRate >= 50) {
                        individualCloseRatioInput.classList.add('conversion-met');
                    } else {
                        individualCloseRatioInput.classList.add('conversion-not-met');
                    }
                }
            });

            const closeRatio = totalDiscovered > 0 ? (totalSold / totalDiscovered * 100) : 0;
            const averageDiscoveredSales = numberOfCars > 0 ? (totalDiscovered / numberOfCars) : 0;
            const averageSoldSales = numberOfCars > 0 ? (totalSold / numberOfCars) : 0;
            const percentageOfInsuranceClaims = numberOfCars > 0 ? (totalInsuranceClaims / numberOfCars * 100) : 0; // Calculate percentage

            document.getElementById('totalDiscoveredSales').innerText = totalDiscovered.toFixed(2);
            document.getElementById('totalSoldSales').innerText = totalSold.toFixed(2);
            document.getElementById('closeRatio').innerText = closeRatio.toFixed(2) + '%';
            document.getElementById('totalCars').innerText = numberOfCars;
            document.getElementById('averageDiscoveredSales').innerText = averageDiscoveredSales.toFixed(2);
            document.getElementById('averageSoldSales').innerText = averageSoldSales.toFixed(2);
            document.getElementById('totalCustomerCalls').innerText = totalCustomerCalls;
            document.getElementById('totalInsuranceClaims').innerText = totalInsuranceClaims; // Update display
            document.getElementById('percentageOfInsuranceClaims').innerText = percentageOfInsuranceClaims.toFixed(2) + '%'; // Update display

            document.getElementById('hiddenTotalDiscoveredSales').value = totalDiscovered.toFixed(2);
            document.getElementById('hiddenTotalSoldSales').value = totalSold.toFixed(2);
            document.getElementById('hiddenCloseRatio').value = closeRatio.toFixed(2) + '%';
            document.getElementById('hiddenTotalCars').value = numberOfCars;
            document.getElementById('hiddenAverageDiscoveredSales').value = averageDiscoveredSales.toFixed(2);
            document.getElementById('hiddenAverageSoldSales').value = averageSoldSales.toFixed(2);
            document.getElementById('hiddenTotalCustomerCalls').value = totalCustomerCalls;
            document.getElementById('hiddenTotalInsuranceClaims').value = totalInsuranceClaims; // Update hidden input
            document.getElementById('hiddenPercentageOfInsuranceClaims').value = percentageOfInsuranceClaims.toFixed(2) + '%'; // Update hidden input

            updateRemainingGoal();
        }

        // New function to calculate totals for a single car row
        function updateCarRowTotals(index) {
            const totalDiscoveredInput = document.getElementById(`carDiscoveredSales_${index}`);
            const insuranceSoldInput = document.getElementById(`carInsuranceSold_${index}`);
            const customerPaySoldInput = document.getElementById(`carCustomerPaySold_${index}`);
            const carTotalSoldInput = document.getElementById(`carTotalSold_${index}`);
            const individualCloseRatioInput = document.getElementById(`carIndividualCloseRatio_${index}`);

            const hasInsuranceCheckbox = document.getElementById(`carHasInsurancePortion_${index}`);
            const hasCustomerPayCheckbox = document.getElementById(`carHasCustomerPayPortion_${index}`);

            const totalDiscovered = parseFloat(totalDiscoveredInput?.value) || 0;

            let totalSoldForCalculation = 0;

            // If insurance or customer pay portions are active, sum them for totalSoldForCalculation
            if (hasInsuranceCheckbox?.checked || hasCustomerPayCheckbox?.checked) {
                const insuranceSold = parseFloat(insuranceSoldInput?.value) || 0;
                const customerPaySold = parseFloat(customerPaySoldInput?.value) || 0;
                totalSoldForCalculation = insuranceSold + customerPaySold;
                // Also update the carTotalSoldInput field with this calculated value
                if (carTotalSoldInput) {
                    carTotalSoldInput.value = totalSoldForCalculation.toFixed(2);
                }
            } else {
                // If no insurance/customer pay portions are active, use the manually entered value in carTotalSoldInput
                totalSoldForCalculation = parseFloat(carTotalSoldInput?.value) || 0;
            }

            let individualConversionRate = 0;
            if (totalDiscovered > 0) {
                individualConversionRate = (totalSoldForCalculation / totalDiscovered) * 100;
            }

            if (individualCloseRatioInput) {
                individualCloseRatioInput.value = individualConversionRate.toFixed(2) + '%';
                individualCloseRatioInput.classList.remove('conversion-met', 'conversion-not-met');
                if (individualConversionRate >= 50) {
                    individualCloseRatioInput.classList.add('conversion-met');
                } else {
                    individualCloseRatioInput.classList.add('conversion-not-met');
                }
            }
        }


        // Function declarations for other helper functions
        function setCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('reportDate').value = `${year}-${month}-${day}`;
        }

        function getFormattedDateForFilename() {
            const today = new Date();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const yy = String(today.getFullYear()).slice(-2); // Get last two digits of the year
            return `${mm}${dd}${yy}`;
        }

        function updateDailyGoalBasedOnPriorDay() {
            const priorDayTotal = parseFloat(document.getElementById('priorDayTotal').value) || 0;
            const dailyGoalInput = document.getElementById('dailyGoal');
            const adjustedDailyGoal = baseDailyGoal + priorDayTotal;
            dailyGoalInput.value = adjustedDailyGoal.toFixed(2);
            updateRemainingGoal();
        }

        function updateRemainingGoal() {
            const dailyGoal = parseFloat(document.getElementById('dailyGoal').value) || 0;
            let currentDaySoldSales = 0;

            document.querySelectorAll('input[name="carTotalSold[]"]').forEach(input => {
                currentDaySoldSales += parseFloat(input.value) || 0;
            });

            const remainingGoal = dailyGoal - currentDaySoldSales;

            const remainingGoalValueTop = document.getElementById('remainingDailyGoalValueTop');
            const remainingGoalValueBottom = document.getElementById('remainingDailyGoalValueBottom');
            const remainingGoalContainerTop = document.getElementById('remainingDailyGoalTop');
            const remainingGoalContainerBottom = document.getElementById('remainingDailyGoalBottom');

            remainingGoalValueTop.innerText = remainingGoal.toFixed(2);
            remainingGoalValueBottom.innerText = remainingGoal.toFixed(2);
            document.getElementById('hiddenRemainingDailyGoal').value = remainingGoal.toFixed(2);

            if (remainingGoal <= 0) {
                remainingGoalContainerTop.classList.remove('goal-not-met');
                remainingGoalContainerTop.classList.add('goal-met');
                remainingGoalContainerBottom.classList.remove('goal-not-met');
                remainingGoalContainerBottom.classList.add('goal-met');
            } else {
                remainingGoalContainerTop.classList.remove('goal-met');
                remainingGoalContainerTop.classList.add('goal-not-met');
                remainingGoalContainerBottom.classList.remove('goal-met');
                remainingGoalContainerBottom.classList.add('goal-not-met');
            }
        }

        function combineCarEntries(originalIndex, duplicateIndex) {
            const originalRow = document.querySelectorAll('#carSalesEntries .form-row')[originalIndex];
            const duplicateRow = document.querySelectorAll('#carSalesEntries .form-row')[duplicateIndex];

            if (!originalRow || !duplicateRow) {
                console.error('Error: Original or duplicate row not found for combining.');
                return;
            }

            const origDiscoveredInput = originalRow.querySelector(`input[name="carDiscoveredSales[]"]`);
            const origInsuranceSoldInput = originalRow.querySelector(`#carInsuranceSold_${originalIndex + 1}`);
            const origCustomerPaySoldInput = originalRow.querySelector(`#carCustomerPaySold_${originalIndex + 1}`);
            const origHasInsuranceCheckbox = originalRow.querySelector(`#carHasInsurancePortion_${originalIndex + 1}`);
            const origHasCustomerPayCheckbox = originalRow.querySelector(`#carHasCustomerPayPortion_${originalIndex + 1}`);
            const origTotalSoldInput = originalRow.querySelector(`#carTotalSold_${originalIndex + 1}`);

            const dupDiscovered = parseFloat(duplicateRow.querySelector(`input[name="carDiscoveredSales[]"]`)?.value) || 0;
            const dupInsuranceSold = parseFloat(duplicateRow.querySelector(`#carInsuranceSold_${duplicateIndex + 1}`)?.value) || 0;
            const dupCustomerPaySold = parseFloat(duplicateRow.querySelector(`#carCustomerPaySold_${duplicateIndex + 1}`)?.value) || 0;
            const dupTotalSold = parseFloat(duplicateRow.querySelector(`#carTotalSold_${duplicateIndex + 1}`)?.value) || 0;

            if (origDiscoveredInput) {
                origDiscoveredInput.value = ((parseFloat(origDiscoveredInput.value) || 0) + dupDiscovered).toFixed(2);
            }

            if (origInsuranceSoldInput) {
                origInsuranceSoldInput.value = ((parseFloat(origInsuranceSoldInput.value) || 0) + dupInsuranceSold).toFixed(2);
            }
            if (origHasInsuranceCheckbox) {
                origHasInsuranceCheckbox.checked = true;
            }

            if (origCustomerPaySoldInput) {
                origCustomerPaySoldInput.value = ((parseFloat(origCustomerPaySoldInput.value) || 0) + dupCustomerPaySold).toFixed(2);
            }
            if (origHasCustomerPayCheckbox) {
                origHasCustomerPayCheckbox.checked = true;
            }

            if (origTotalSoldInput) {
                origTotalSoldInput.value = ((parseFloat(origTotalSoldInput.value) || 0) + dupTotalSold).toFixed(2);
            }

            toggleCarPortionFields(originalIndex + 1);
            duplicateRow.remove();
            updateRemoveButtonsVisibility('carSalesEntries');
            updateRunningTotals();
            showMessageBox('Combined Successfully', `The new entry has been combined into the original RO ${currentDuplicateRo}.`);
        }

        // Function to toggle visibility of insurance and customer pay portion fields
        function toggleCarPortionFields(index) {
            const hasInsuranceCheckbox = document.getElementById(`carHasInsurancePortion_${index}`);
            const hasCustomerPayCheckbox = document.getElementById(`carHasCustomerPayPortion_${index}`);

            const insuranceContainer = document.getElementById(`carInsurancePortionContainer_${index}`);
            const customerPayCheckboxContainer = document.getElementById(`carCustomerPayCheckboxContainer_${index}`);
            const customerPayContainer = document.getElementById(`carCustomerPayPortionContainer_${index}`);

            // Only hide/show containers, do not clear values automatically
            if (hasInsuranceCheckbox && insuranceContainer) {
                insuranceContainer.style.display = hasInsuranceCheckbox.checked ? 'block' : 'none';
            }
            if (customerPayCheckboxContainer) {
                customerPayCheckboxContainer.style.display = (hasInsuranceCheckbox && hasInsuranceCheckbox.checked) ? 'flex' : 'none';
            }
            if (hasCustomerPayCheckbox && customerPayContainer) {
                customerPayContainer.style.display = hasCustomerPayCheckbox.checked ? 'block' : 'none';
            }

            // Ensure customer pay checkbox is unchecked if insurance is unchecked
            if (hasInsuranceCheckbox && !hasInsuranceCheckbox.checked && hasCustomerPayCheckbox) {
                hasCustomerPayCheckbox.checked = false;
            }

            updateCarRowTotals(index); // Recalculate totals for this row (based on current values)
            updateRunningTotals(); // Update overall totals
        }

        // New function to handle input on RO# and Last Name fields (now triggered by delegation)
        function handleCarInput(index) {
            // This function is now mostly for duplicate check logic.
            // Actual calculation updates are handled by event delegation on relevant number inputs.
            updateRunningTotals(); // Trigger overall update for duplicate check
        }


        // --- UI Manipulation and Helper Functions ---

        function addCallEntry() {
            callEntryCount++;
            const callEntriesDiv = document.getElementById('callEntries');
            const newEntry = document.createElement('div');
            newEntry.className = 'form-row items-end';
            newEntry.innerHTML = `
                <div class="form-col">
                    <label for="callCustomerName_${callEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Customer Name</label>
                    <input type="text" id="callCustomerName_${callEntryCount}" name="callCustomerName[]" placeholder="Customer Name" class="w-full rounded-md">
                </div>
                <div class="form-col">
                    <label for="callCustomerPhone_${callEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Phone Number</label>
                    <input type="text" id="callCustomerPhone_${callEntryCount}" name="callCustomerPhone[]" placeholder="(XXX) XXX-XXXX" class="w-full rounded-md" oninput="formatPhoneNumber(this)">
                </div>
                <div class="form-col flex items-center">
                    <input type="checkbox" id="callBookedAppointment_${callEntryCount}" name="callBookedAppointment[]" class="mr-2" onchange="toggleCallFieldsVisibility(${callEntryCount})">
                    <label for="callBookedAppointment_${callEntryCount}" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Booked Appointment?</label>
                </div>
                <div class="form-col flex items-center">
                    <input type="checkbox" id="callLostLead_${callEntryCount}" name="callLostLead[]" class="mr-2" onchange="toggleCallFieldsVisibility(${callEntryCount})">
                    <label for="callLostLead_${callEntryCount}" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Lost Lead?</label>
                </div>
                <div class="form-col" id="callLostCostContainer_${callEntryCount}" style="display:none;">
                    <label for="callLostCost_${callEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Estimated Lost Cost ($)</label>
                    <input type="number" id="callLostCost_${callEntryCount}" name="callLostCost[]" placeholder="e.g., 250" class="w-full rounded-md" min="0" step="0.01">
                </div>
                <div class="form-col" id="callReasonContainer_${callEntryCount}" style="display:none;">
                    <label for="callReason_${callEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Reason for Loss</label>
                    <select id="callReason_${callEntryCount}" name="callReason[]" class="w-full rounded-md" onchange="toggleOtherReason(this, ${callEntryCount}, 'call')">
                        <option value="">Select Reason</option>
                        <option value="Cost">Cost</option>
                        <option value="Appointment Availability">Appointment Availability</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-col" id="callSourceContainer_${callEntryCount}" style="display:none;">
                    <label for="callSource_${callEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Source</label>
                    <select id="callSource_${callEntryCount}" name="callSource[]" class="w-full rounded-md">
                        <option value="">Select Source</option>
                        <option value="Referral">Referral</option>
                        <option value="Repair Pal">Repair Pal</option>
                        <option value="Google">Google</option>
                        <option value="Social Media">Social Media</option>
                    </select>
                </div>
                <div class="w-full sm:w-auto">
                    <button type="button" onclick="removeCallEntry(this)" class="btn-remove">Remove</button>
                </div>
                <div class="form-col w-full" id="callOtherReasonContainer_${callEntryCount}" style="display:none;">
                    <label for="callOtherReason_${callEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Other Reason Details</label>
                    <textarea id="callOtherReason_${callEntryCount}" name="callOtherReason[]" rows="2" placeholder="Please specify other reason" class="w-full rounded-md"></textarea>
                </div>
            `;
            callEntriesDiv.appendChild(newEntry);
            updateRemoveButtonsVisibility('callEntries');
            updateRunningTotals();
            // Initialize visibility for the newly added row
            toggleCallFieldsVisibility(callEntryCount);
        }

        function removeCallEntry(button) {
            button.closest('.form-row').remove();
            updateRemoveButtonsVisibility('callEntries');
            updateRunningTotals();
        }

        // Function to add a new car entry row
        function addCarEntry() {
            carEntryCount++;
            const carSalesEntriesDiv = document.getElementById('carSalesEntries');
            const newEntry = document.createElement('div');
            newEntry.className = 'form-row items-end';
            newEntry.innerHTML = `
                <div class="form-col">
                    <label for="carRepairOrderNumber_${carEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">RO#</label>
                    <input type="text" id="carRepairOrderNumber_${carEntryCount}" name="carRepairOrderNumber[]" placeholder="RO Number" class="w-full rounded-md">
                </div>
                <div class="form-col">
                    <label for="carLastName_${carEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Last Name</label>
                    <input type="text" id="carLastName_${carEntryCount}" name="carLastName[]" placeholder="Customer Last Name" class="w-full rounded-md">
                </div>
                <div class="form-col">
                    <label for="carDiscoveredSales_${carEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Total Discovered ($)</label>
                    <input type="number" id="carDiscoveredSales_${carEntryCount}" name="carDiscoveredSales[]" placeholder="e.g., 500" class="w-full rounded-md" min="0" step="0.01">
                </div>

                <div class="w-full flex flex-wrap items-center gap-4 mt-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="carHasInsurancePortion_${carEntryCount}" name="carHasInsurancePortion[]" class="mr-2">
                        <label for="carHasInsurancePortion_${carEntryCount}" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Has Insurance Portion?</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="carAppointmentScheduled_${carEntryCount}" name="carAppointmentScheduled[]" class="mr-2">
                        <label for="carAppointmentScheduled_${carEntryCount}" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Future Appointment Scheduled?</label>
                    </div>
                </div>

                <div class="form-col w-full" id="carInsurancePortionContainer_${carEntryCount}" style="display:none;">
                    <label class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Insurance Sold ($)</label>
                    <input type="number" id="carInsuranceSold_${carEntryCount}" name="carInsuranceSold[]" placeholder="Sold ($)" class="w-full rounded-md" min="0" step="0.01">
                </div>

                <div class="flex items-center mt-2" id="carCustomerPayCheckboxContainer_${carEntryCount}" style="display:none;">
                    <input type="checkbox" id="carHasCustomerPayPortion_${carEntryCount}" name="carHasCustomerPayPortion[]" class="mr-2">
                    <label for="carHasCustomerPayPortion_${carEntryCount}" class="text-gray-700 dark:text-gray-200 text-sm font-medium">Has Customer Pay Portion?</label>
                </div>
                <div class="form-col w-full" id="carCustomerPayPortionContainer_${carEntryCount}" style="display:none;">
                    <label class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Customer Pay Sold ($)</label>
                    <input type="number" id="carCustomerPaySold_${carEntryCount}" name="carCustomerPaySold[]" placeholder="Sold ($)" class="w-full rounded-md" min="0" step="0.01">
                </div>

                <!-- CORRECTED: Changed 'form-row' to a plain 'div' with flex classes -->
                <div class="flex flex-wrap w-full mt-2 gap-4">
                    <div class="form-col">
                        <label for="carTotalSold_${carEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Total Sold ($)</label>
                        <input type="number" id="carTotalSold_${carEntryCount}" name="carTotalSold[]" class="w-full rounded-md">
                    </div>
                    <div class="form-col">
                        <label for="carIndividualCloseRatio_${carEntryCount}" class="block text-gray-700 dark:text-gray-200 text-sm font-medium mb-1">Close Ratio (%)</label>
                        <input type="text" id="carIndividualCloseRatio_${carEntryCount}" name="carIndividualCloseRatio[]" class="w-full rounded-md" readonly>
                    </div>
                </div>

                <div class="w-full sm:w-auto">
                    <button type="button" onclick="removeCarEntry(this)" class="btn-remove">Remove</button>
                </div>
            `;
            carSalesEntriesDiv.appendChild(newEntry); // Append the new entry first
            updateRemoveButtonsVisibility('carSalesEntries');
            updateRemainingGoal();
            // No direct updateCarRowTotals or toggleCarPortionFields here, let delegation handle it
            updateRunningTotals(); // Call updateRunningTotals to ensure new row counts are updated
        }

        function removeCarEntry(button) {
            button.closest('.form-row').remove();
            updateRemoveButtonsVisibility('carSalesEntries');
            updateRemainingGoal();
            updateRunningTotals();
        }

        // Function to toggle visibility of the "Other Reason Details" textarea
        function toggleOtherReason(selectElement, index, type) {
            const otherReasonContainer = document.getElementById(`${type}OtherReasonContainer_${index}`);
            if (selectElement.value === 'Other') {
                otherReasonContainer.style.display = 'block';
            } else {
                otherReasonContainer.style.display = 'none';
                document.getElementById(`${type}OtherReason_${index}`).value = ''; // Clear content when hidden
            }
        }

        // Consolidated function to toggle visibility of fields in 'New Customer Leads' section
        function toggleCallFieldsVisibility(index) {
            const bookedCheckbox = document.getElementById(`callBookedAppointment_${index}`);
            const lostLeadCheckbox = document.getElementById(`callLostLead_${index}`);

            const lostCostContainer = document.getElementById(`callLostCostContainer_${index}`);
            const reasonContainer = document.getElementById(`callReasonContainer_${index}`);
            const sourceContainer = document.getElementById(`callSourceContainer_${index}`);
            const otherReasonContainer = document.getElementById(`callOtherReasonContainer_${index}`); // Get other reason container

            // Handle Lost Lead fields
            if (lostLeadCheckbox && lostCostContainer && reasonContainer) {
                if (lostLeadCheckbox.checked) {
                    lostCostContainer.style.display = 'block';
                    reasonContainer.style.display = 'block';
                    // Add w-full to force them to a new line and align
                    lostCostContainer.classList.add('w-full');
                    reasonContainer.classList.add('w-full');

                    // Re-check other reason visibility if 'Other' was selected
                    const reasonSelect = document.getElementById(`callReason_${index}`);
                    if (reasonSelect && reasonSelect.value === 'Other') {
                        if (otherReasonContainer) otherReasonContainer.style.display = 'block';
                    }
                    // If lost lead is checked, uncheck booked appointment and hide source
                    if (bookedCheckbox && bookedCheckbox.checked) {
                        bookedCheckbox.checked = false;
                        if (sourceContainer) sourceContainer.style.display = 'none';
                        if (document.getElementById(`callSource_${index}`)) document.getElementById(`callSource_${index}`).value = '';
                        sourceContainer.classList.remove('w-full');
                    }
                } else {
                    lostCostContainer.style.display = 'none';
                    reasonContainer.style.display = 'none';
                    if (otherReasonContainer) otherReasonContainer.style.display = 'none'; // Ensure other reason is also hidden
                    lostCostContainer.classList.remove('w-full');
                    reasonContainer.classList.remove('w-full');

                    // Clear values when hidden
                    if (document.getElementById(`callLostCost_${index}`)) document.getElementById(`callLostCost_${index}`).value = '';
                    if (document.getElementById(`callReason_${index}`)) document.getElementById(`callReason_${index}`).value = '';
                    if (document.getElementById(`callOtherReason_${index}`)) document.getElementById(`callOtherReason_${index}`).value = '';
                }
            }

            // Handle Booked Appointment fields (specifically Source)
            if (bookedCheckbox && sourceContainer) {
                if (bookedCheckbox.checked) {
                    sourceContainer.style.display = 'block';
                    sourceContainer.classList.add('w-full'); // Add w-full to force it to a new line and align

                    // If lost lead is checked, uncheck lost lead and hide lost cost/reason
                    if (lostLeadCheckbox && lostLeadCheckbox.checked) {
                        lostLeadCheckbox.checked = false;
                        if (lostCostContainer) lostCostContainer.style.display = 'none';
                        if (reasonContainer) reasonContainer.style.display = 'none';
                        if (otherReasonContainer) otherReasonContainer.style.display = 'none';
                        if (document.getElementById(`callLostCost_${index}`)) document.getElementById(`callLostCost_${index}`).value = '';
                        if (document.getElementById(`callReason_${index}`)) document.getElementById(`callReason_${index}`).value = '';
                        if (document.getElementById(`callOtherReason_${index}`)) document.getElementById(`callOtherReason_${index}`).value = '';
                        lostCostContainer.classList.remove('w-full');
                        reasonContainer.classList.remove('w-full');
                    }
                } else {
                    sourceContainer.style.display = 'none';
                    sourceContainer.classList.remove('w-full'); // Remove w-full when hidden
                    // Clear value when hidden
                    if (document.getElementById(`callSource_${index}`)) document.getElementById(`callSource_${index}`).value = '';
                }
            }
        }


        function updateRemoveButtonsVisibility(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const removeButtons = container.querySelectorAll('.form-row .btn-remove');
            if (removeButtons.length <= 1) {
                removeButtons.forEach(btn => btn.classList.add('hidden'));
            } else {
                removeButtons.forEach(btn => btn.classList.remove('hidden'));
            }
        }

        async function savePageAsImage() {
            showMessageBox('Saving Image...', 'Please wait while the page is captured and prepared for download.');
            try {
                const formContainer = document.querySelector('.container');
                const messageBox = document.getElementById('messageBox');

                const wasMessageBoxVisible = !messageBox.classList.contains('hidden');
                if (wasMessageBoxVisible) {
                    messageBox.classList.add('hidden');
                }

                const originalOverflow = document.body.style.overflow;
                document.body.style.overflow = 'auto';

                setTimeout(async () => {
                    try {
                        const canvas = await html2canvas(formContainer, {
                            scale: 2,
                            useCORS: true,
                            windowWidth: formContainer.scrollWidth,
                            windowHeight: formContainer.scrollHeight,
                            scrollX: -window.scrollX,
                            scrollY: -window.scrollY,
                            logging: false
                        });

                        const image = canvas.toDataURL('image/png');
                        const a = document.createElement('a');
                        const filenameDate = getFormattedDateForFilename();
                        const advisorName = document.getElementById('serviceAdvisorName').value.replace(/\s/g, '');
                        const filename = `DailySalesForm_${advisorName}_${filenameDate}.png`;

                        a.href = image;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);

                        showMessageBox('Success!', `The image "${filename}" has been downloaded.`);

                    } catch (error) {
                        console.error('Error generating canvas from page:', error);
                        showMessageBox('Error', 'Failed to capture page image. Please try again.');
                    } finally {
                        document.body.style.overflow = originalOverflow;
                        if (wasMessageBoxVisible) {
                            messageBox.classList.remove('hidden');
                        }
                    }
                }, 100);

            } catch (error) {
                console.error('Error in savePageAsImage function:', error);
                showMessageBox('Error', 'An unexpected error occurred during image capture.');
            }
        }

        // Function to show a custom message box
        function showMessageBox(title, message) {
            document.getElementById('messageBoxTitle').innerText = title;
            document.getElementById('messageBoxContent').innerText = message;
            document.getElementById('messageBox').classList.remove('hidden');
        }

        // Function to close the custom message box
        function closeMessageBox() {
            document.getElementById('messageBox').classList.add('hidden');
        }

        // Function to show a custom confirmation box
        let confirmCallback = null; // Stores the callback function
        function showConfirmationBox(title, message, callback) {
            document.getElementById('confirmationBoxTitle').innerText = title;
            document.getElementById('confirmationBoxContent').innerText = message;
            document.getElementById('confirmationBox').classList.remove('hidden');
            confirmCallback = callback; // Store the callback
        }

        // Function to handle confirmation box button clicks
        function confirmAction(result) {
            document.getElementById('confirmationBox').classList.add('hidden');
            if (confirmCallback) {
                confirmCallback(result); // Call the stored callback with the result (true/false)
                confirmCallback = null; // Clear the callback
            }
        }


        // Phone number formatting function
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, ''); // Remove all non-digits
            let formattedValue = '';

            if (value.length > 0) {
                formattedValue += '(' + value.substring(0, 3);
            }
            if (value.length >= 4) {
                formattedValue += ') ' + value.substring(3, 6);
            }
            if (value.length >= 7) {
                formattedValue += '-' + value.substring(6, 10);
            }
            input.value = formattedValue;
        }

        // Handle form submission (now relies on Formspree's action attribute)
        document.getElementById('salesForm').addEventListener('submit', async function(event) {
            // Formspree will automatically collect all named inputs.
            // We just need to ensure calculated hidden fields are updated.
            updateRunningTotals(); // Ensure all totals are up-to-date before submission
        });

        // Initial calls to set button visibility and calculate goal on page load
        document.addEventListener('DOMContentLoaded', () => {
            setCurrentDate();
            updateRemoveButtonsVisibility('callEntries');
            updateRemoveButtonsVisibility('carSalesEntries');
            updateDailyGoalBasedOnPriorDay();
            updateRunningTotals(); // Call updateRunningTotals to set initial values

            // Event delegation for car sales inputs (numerical and text for duplicate check)
            document.getElementById('carSalesEntries').addEventListener('input', (event) => {
                const target = event.target;
                // Check if the target is an input field relevant to car calculations
                if (target.matches('input[name^="carDiscoveredSales"], input[name^="carInsuranceSold"], input[name^="carCustomerPaySold"], input[name^="carTotalSold"]')) {
                    // Get the index from the ID (e.g., carDiscoveredSales_1 -> 1)
                    const indexMatch = target.id.match(/_(\d+)$/);
                    if (indexMatch) {
                        const index = parseInt(indexMatch[1]);
                        updateCarRowTotals(index); // This recalculates the individual row's totalSold and close ratio
                        updateRunningTotals(); // This sums ALL carTotalSold values.
                    }
                } else if (target.matches('input[name^="carRepairOrderNumber"], input[name^="carLastName"]')) {
                    // For RO# and Last Name, only need to update running totals for duplicate check
                    updateRunningTotals();
                }
            });

            // Event delegation for car sales checkboxes (for toggling sections and total updates)
            document.getElementById('carSalesEntries').addEventListener('change', (event) => {
                const target = event.target;
                if (target.matches('input[name^="carHasInsurancePortion"]')) {
                    const indexMatch = target.id.match(/_(\d+)$/);
                    if (indexMatch) {
                        const index = parseInt(indexMatch[1]);
                        // We do NOT call updateRunningTotals here directly, as toggleCarPortionFields will call it.
                        toggleCarPortionFields(index); // This will also call updateCarRowTotals and then updateRunningTotals
                    }
                } else if (target.matches('input[name^="carHasCustomerPayPortion"]')) {
                    const indexMatch = target.id.match(/_(\d+)$/);
                    if (indexMatch) {
                        const index = parseInt(indexMatch[1]);
                        // We do NOT call updateRunningTotals here directly, as toggleCarPortionFields will call it.
                        toggleCarPortionFields(index); // This will also call updateCarRowTotals and then updateRunningTotals
                    }
                } else if (target.matches('input[name^="carAppointmentScheduled"]')) {
                    // For appointment scheduled, just trigger overall update
                    updateRunningTotals();
                }
            });


            // Initialize visibility for existing call entries (if any)
            document.querySelectorAll('#callEntries .form-row').forEach((row, index) => {
                toggleCallFieldsVisibility(index + 1);
            });

            // Initialize visibility for existing car entries (if any)
            document.querySelectorAll('#carSalesEntries .form-row').forEach((row, index) => {
                toggleCarPortionFields(index + 1); // Initialize visibility for car portion fields
            });
        });
    </script>
</body>
</html>
